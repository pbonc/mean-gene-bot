pipeline {
    agent any

    environment {
        SSH_KEY_PATH = "${env.WORKSPACE}/.ssh/jenkins_bot_key"
        NODES = """[
            [host: "192.168.1.10", user: "dar"],      // meangenebrain
            [host: "192.168.1.20", user: "ubuntu"]     // meanpi
        ]"""
    }

    stages {
        stage('Update & Upgrade Hardware') {
            steps {
                script {
                    def nodes = readJSON text: NODES
                    nodes.each { node ->
                        echo "Connecting to ${node.host} as ${node.user}..."

                        sh """
                        ssh -o StrictHostKeyChecking=no -i ${SSH_KEY_PATH} ${node.user}@${node.host} '
                            echo "[INFO] Updating system..."
                            sudo apt-get update &&
                            sudo apt-get upgrade -y &&
                            if [ -f /var/run/reboot-required ]; then
                                echo "[INFO] Reboot required. Rebooting..."
                                sudo reboot
                            else
                                echo "[INFO] No reboot needed."
                            fi
                        '
                        """
                    }
                }
            }
        }
    }
}
