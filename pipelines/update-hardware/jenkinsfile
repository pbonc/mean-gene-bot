pipeline {
    agent any

    environment {
        TARGETS_FILE = 'pipelines/update-hardware/targets.json'
    }

    stages {
        stage('Update & Upgrade Hardware') {
            steps {
                script {
                    def targets = readJSON file: env.TARGETS_FILE

                    for (target in targets) {
                        echo "Updating ${target.host} as ${target.user}..."

                        def updateCommand = """
                            ssh -o StrictHostKeyChecking=no -i ~/.ssh/jenkins_bot_key ${target.user}@${target.host} \\
                            'sudo apt-get update && sudo apt-get upgrade -y && sudo reboot || true'
                        """

                        def result = sh(
                            script: updateCommand,
                            returnStatus: true
                        )

                        if (result != 0) {
                            echo "Update failed on ${target.host} (exit code ${result})"
                        } else {
                            echo "Update succeeded on ${target.host}"
                        }
                    }
                }
            }
        }
    }
}
