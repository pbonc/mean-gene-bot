pipeline {
    agent any

    environment {
        SSH_KEY = '/var/lib/jenkins/.ssh/jenkins_bot_key'
        TARGETS_FILE = 'pipelines/update-hardware/targets.json'
    }

    stages {
        stage('Update & Upgrade Hardware') {
            steps {
                script {
                    def targets = readJSON file: env.TARGETS_FILE
                    def results = []

                    for (target in targets) {
                        def host = target.host
                        def user = target.user

                        echo "Updating ${host} as ${user}..."

                        def result = sh(
                            script: """
                                ssh -o StrictHostKeyChecking=no -i ${SSH_KEY} ${user}@${host} \\
                                'sudo apt-get update && sudo apt-get upgrade -y && sudo reboot &' || true
                            """,
                            returnStatus: true
                        )

                        if (result == 0) {
                            echo "✅ Update succeeded on ${host}"
                            results << "✅ ${host} (${user})"
                        } else {
                            echo "❌ Update failed on ${host} (exit code ${result})"
                            results << "❌ ${host} (${user})"
                        }
                    }

                    echo "\n========================"
                    echo "🔧 Final Update Summary:"
                    results.each { line -> echo line }
                    echo "========================\n"
                }
            }
        }
    }
}
